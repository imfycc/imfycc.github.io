---
title: å†™ç»™è‡ªå·±çš„JavaScriptç³»åˆ—ä¹‹ä¸€æ­¥æ­¥å†™ä¸ª JavaScript è§£é‡Šå™¨
date: 2019-03-11 22:20:21
updated: 2019-04-23 22:20:21
tags:
categories: ç¼–ç¨‹
---

ä¸ºäº†æ›´å¥½çš„ç†è§£ JavaScript çš„å„ç§è¯­è¨€ç‰¹æ€§ï¼Œæ›´å¥½çš„æŒæ¡ JavaScript çš„åº•å±‚åŸç† ğŸ˜„ã€‚æˆ‘æƒ³åŠ¨æ‰‹å†™ä¸€ä¸ª JavaScript ç‰ˆçš„ JavaScript è§£é‡Šå™¨ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯èƒ½å¤Ÿè¿è¡Œ JavaScriptï¼ˆä»¥ä¸‹ç®€ç§° js ï¼‰ ä»£ç ã€‚æˆ‘ä»¬å¹³æ—¶å†™çš„ js ä»£ç ä¸€èˆ¬ç”±æµè§ˆå™¨æˆ–è€… Nodejs çš„è§£é‡Šå™¨æ¥è§£é‡Šå¹¶æ‰§è¡Œï¼Œæœ¬æ–‡çš„ç›®æ ‡å°±æ˜¯å†™ä¸€ä¸ªèƒ½å¤Ÿè§£é‡Š js ä»£ç çš„è§£é‡Šå™¨ ğŸš€ã€‚

å†™ä¸€ä¸ªè§£é‡Šå™¨çš„å·¥ç¨‹ï¼Œæƒ³ä¸€æƒ³å°±æ„Ÿè§‰å¥½å¤§ã€‚å’±ä»¬å¯ä»¥æ‹†è§£ä¸€ä¸‹ï¼Œä¸€æ­¥æ­¥æ¥ã€‚æ¯å®ç°ä¸€ä¸ªå°ç›®æ ‡éƒ½ä¼šå¾ˆæœ‰æˆå°±æ„Ÿï¼Œä¸è‡³äºæœ›è€Œå´æ­¥ ğŸ¶ã€‚

## ç¬¬ä¸€é˜¶æ®µçš„ç›®æ ‡

âœ… 1ã€é¦–å…ˆå®ç°æ‰“å°å€¼

```js
const x = 'Hello World!';
console.log(x);
```

2ã€ç„¶åå®ç°åŠ å‡ä¹˜é™¤å››åˆ™è¿ç®—

```js
const x = 1, y = 2;
console.log(x + y);
```

3ã€ç„¶åæˆ‘ä»¬å®ç°å‡½æ•°

```js
function add(x, y) {
  return x + y;
}
console.log(add(1,2));
```

4ã€è¶çƒ­æ‰“é“å®ç°é—­åŒ…ã€‚

> å®ç°é—­åŒ…å…¶å®æˆ‘æƒ³å†™ä¸€ä¸ª js è§£é‡Šå™¨çš„åˆå§‹åŠ¨æœºï¼Œæˆ‘æœ¬æ¥åœ¨å†™ä¸€ç¯‡è§£é‡Šä»€ä¹ˆæ˜¯ js é—­åŒ…çš„æ–‡ç« ï¼Œä½†æ˜¯æˆ‘å†™ç€å†™ç€æ„Ÿè§‰æœ‰ç‚¹æ— èŠï¼Œæ²¡ä»€ä¹ˆæ„æ€ï¼Œå°±æƒ³å®ç°ä¸ª js è§£é‡Šå™¨ã€‚ ä»å¦ä¸€ä¸ªè§’åº¦ç†è§£è¿™ä¸ªé—®é¢˜ã€‚

6ã€å®ç° if æ¡ä»¶è¡¨è¾¾å¼

7ã€å®ç° for å¾ªç¯

8ã€æ‰“åŒ… js å¯ä»¥åœ¨å…¶ä»–æ–‡ä»¶å†…ä½¿ç”¨

> å°†æ‰§è¡Œç»“æœè¾“å‡ºåˆ°å¤–éƒ¨

ä¸Šé¢æ˜¯æˆ‘çš„ç©å…·è®¡åˆ’ã€‚

ğŸ˜Œ ------------------------ è¿™æ˜¯ä¸€æ¡åˆ†å‰²çº¿ ---------------------- ğŸ˜Œ

ä¸‹é¢æ˜¯æˆ‘çš„å¼€å‘è¿‡ç¨‹ã€‚

## å‚è€ƒèµ„æ–™

æˆ‘æ‰¾åˆ°çš„ä¸€äº›ç”¨ js å®ç° js è§£é‡Šå™¨çš„æ–‡ç« ï¼š

* [å¾®ä¿¡å°ç¨‹åºä¹Ÿè¦å¼ºè¡Œçƒ­æ›´ä»£ç ï¼Œé¹…å‚ä¸æœä½ æ¥è‚›æˆ‘å‘€](https://zhuanlan.zhihu.com/p/34191831)
* [ä»é›¶å¼€å§‹å†™ä¸€ä¸ªJavascriptè§£æå™¨](https://juejin.im/post/5aa25be1518825557b4c5720#heading-11)
* [å‰ç«¯ä¸ç¼–è¯‘åŸç†â€”â€”ç”¨JSå†™ä¸€ä¸ªJavaScriptè§£é‡Šå™¨](https://segmentfault.com/a/1190000017241258)

å’Œä¸Šé¢æ–‡ç« ç›¸å…³çš„ Github ä¸Šçš„ JavaScript è§£é‡Šå™¨æºç 

> å‰ä¸‰ä¸ªæ˜¯ TypeScript é¡¹ç›®ï¼Œæœ€åä¸€ä¸ªæ˜¯ JavaScript é¡¹ç›®

* [jsjs](https://github.com/bramblex/jsjs)
* [evil-eval](https://github.com/jkeylu/evil-eval)
* [vm.js](https://github.com/axetroy/vm.js)
* [canjs](https://github.com/jrainlau/canjs)

## çƒ­èº«

JavaScript ä»£ç è½¬åŒ–æˆæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰è¿™ä¸€æ­¥ï¼Œç›´æ¥ç”¨ç°æˆçš„åº“å®ç°ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ [`acorn`](https://github.com/acornjs/acorn) åº“ã€‚è¿™æ˜¯ä¸€ä¸ª js çš„è§£æå™¨ï¼Œå¯ä»¥å°† js ä»£ç è§£ææˆ ASTï¼Œ`Babel` æœ€å¼€å§‹ä¹Ÿä½¿ç”¨äº† `acorn`ã€‚

å¦‚æœä½ æƒ³äº†è§£æ•´ä¸ªç¼–è¯‘å™¨çš„å¼€å‘ï¼ˆåŒ…æ‹¬ AST çš„ç”Ÿæˆï¼‰ï¼Œå¯ä»¥çœ‹è¿™ä¸ªé¡¹ç›®[å¾®å‹ç¼–è¯‘å™¨](https://github.com/jamiebuilds/the-super-tiny-compiler)

### æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰

å¤§ä½“è§£é‡Šä¸€ä¸‹ã€‚ğŸµ

> åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼ˆAbstract Syntax Treeï¼ŒASTï¼‰ï¼Œæˆ–ç®€ç§°è¯­æ³•æ ‘ï¼ˆSyntax treeï¼‰ï¼Œæ˜¯æºä»£ç è¯­æ³•ç»“æ„çš„ä¸€ç§æŠ½è±¡è¡¨ç¤ºã€‚å®ƒä»¥æ ‘çŠ¶çš„å½¢å¼è¡¨ç°ç¼–ç¨‹è¯­è¨€çš„è¯­æ³•ç»“æ„ï¼Œæ ‘ä¸Šçš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¡¨ç¤ºæºä»£ç ä¸­çš„ä¸€ç§ç»“æ„ã€‚ä¹‹æ‰€ä»¥è¯´è¯­æ³•æ˜¯â€œæŠ½è±¡â€çš„ï¼Œæ˜¯å› ä¸ºè¿™é‡Œçš„è¯­æ³•å¹¶ä¸ä¼šè¡¨ç¤ºå‡ºçœŸå®è¯­æ³•ä¸­å‡ºç°çš„æ¯ä¸ªç»†èŠ‚ã€‚æ¯”å¦‚ï¼ŒåµŒå¥—æ‹¬å·è¢«éšå«åœ¨æ ‘çš„ç»“æ„ä¸­ï¼Œå¹¶æ²¡æœ‰ä»¥èŠ‚ç‚¹çš„å½¢å¼å‘ˆç°ï¼›è€Œç±»ä¼¼äº if-condition-then è¿™æ ·çš„æ¡ä»¶è·³è½¬è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ä¸¤ä¸ªåˆ†æ”¯çš„èŠ‚ç‚¹æ¥è¡¨ç¤ºã€‚  -- ç»´åŸºç™¾ç§‘

AST çš„ä½œç”¨ï¼š

* ä»£ç é£æ ¼æ£€æµ‹(eslintç­‰)
* ä»£ç çš„æ ¼å¼åŒ–ï¼Œè‡ªåŠ¨è¡¥å…¨
* ä»£ç é«˜äº®
* ä»£ç é”™è¯¯æ£€æŸ¥
* ä»£ç çš„æ··æ·†å‹ç¼©
* è½¬æ¢ä»£ç çš„å·¥å…·ã€‚å¦‚ webpackï¼Œrollupã€‚å„ç§ä»£ç è§„èŒƒä¹‹é—´çš„è½¬æ¢ï¼ŒTypeScript JSX ç­‰è½¬æ¢ä¸ºåŸç”Ÿ js

å®é™…é¡¹ç›®ä¸­å¯¹ AST çš„åº”ç”¨ï¼š

æˆ‘åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„ä¸‰ä¸ªæ¡ˆä¾‹ï¼šğŸŒ

[åˆ†æç»Ÿè®¡å¾®ä¿¡å°ç¨‹åºä»£ç ä½¿ç”¨çš„ api](https://segmentfault.com/a/1190000013423155)

[æ”¯ä»˜å®å’Œå¾®ä¿¡å°ç¨‹åºçš„ä»£ç è½¬æ¢](https://qianduan.group/posts/5a0fe3cc44aec04413ec3d7d)


[ç¾å›¢çš„æ¨¡å—ä¾èµ–å…³ç³»æ£€æµ‹å·¥å…·](https://tech.meituan.com/2014/10/08/the-practice-of-abstract-syntax-trees-in-javascript.html)

## æ­£æ–‡

1ã€ä½¿ç”¨ acorn å°† js è½¬æ¢æˆ ast æŠ½è±¡è¯­æ³•æ ‘

```js
const { Parser } = require('acorn');

class Runjs {
  constructor(code = '') {
    this.ast = Parser.parse(code);
  }
  run() {
    console.log(this.ast);
  }
}

module.exports = Runjs;

new Runjs(`
  let x = 'Hello World!';
  console.log(x);
`).run();
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·çœ‹ä¸€ä¸‹ï¼Œè§£æå‡ºæ¥çš„æŠ½è±¡è¯­æ³•æ ‘ã€‚ğŸ˜‰

[Esprima åœ¨çº¿å·¥å…·](http://esprima.org/demo/parse.html)

[ast](https://astexplorer.net/)

2ã€è§£æå‡ºæ¥çš„ AST æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸ª type å±æ€§ï¼Œè¦åšä¸€ä¸ªèŠ‚ç‚¹éå†å™¨ï¼Œå¤„ç†æ¯ä¸€ä¸ªèŠ‚ç‚¹ã€‚

æœ‰å“ªäº›èŠ‚ç‚¹é‚£ï¼Ÿå¯ä»¥ä»è¿™é‡Œ[æŸ¥çœ‹](https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API)

```js
let x = 'Hello World!';
console.log(x);
```

â¬‡ï¸ ä¸Šé¢çš„ä»£ç ç”Ÿæˆçš„ AST å¦‚ä¸‹ï¼š

```json
{
  "type": "Program",
  "body": [
    {
      "type": "VariableDeclaration",
      "declarations": [
        {
          "type": "VariableDeclarator",
          "id": {
            "type": "Identifier",
            "name": "x"
          },
          "init": {
            "type": "Literal",
            "value": "Hello World!"
          }
        }
      ],
      "kind": "const"
    },
    {
      "type": "ExpressionStatement",
      "expression": {
        "type": "CallExpression",
        "callee": {
          "type": "MemberExpression",
          "computed": false,
          "object": {
            "type": "Identifier",
            "name": "console"
          },
          "property": {
            "type": "Identifier",
            "name": "log"
          }
        },
        "arguments": [
          {
            "type": "Identifier",
            "name": "x"
          }
        ]
      }
    }
  ]
}
```

å¦‚ä½•å®ç°èŠ‚ç‚¹éå†å™¨ï¼Ÿ

å…ˆå®šä¹‰ä¸€ä¸ªèŠ‚ç‚¹æ§åˆ¶å™¨ nodeHandlerï¼Œåˆ†åˆ«å¤„ç†æ¯ä¸€ä¸ªèŠ‚ç‚¹

ä¸‹é¢æ˜¯ä¸Šé¢ç”¨åˆ°çš„èŠ‚ç‚¹ç±»å‹ï¼š

```js
const nodeHandler = {
  Program(nodeIterator) {
    /*å¤„ç† Program ç±»å‹çš„ä»£ç  */
  },
  VariableDeclaration(nodeIterator) {
    /*å¤„ç† VariableDeclaration ç±»å‹çš„ä»£ç  */
  },
  Identifier(nodeIterator) {},
  Literal(nodeIterator) {},
  ExpressionStatement(nodeIterator) {},
  CallExpression(nodeIterator) {},
  MemberExpression(nodeIterator) {},
};
```

ç„¶åå®ç°ä¸€ä¸ªèŠ‚ç‚¹éå†å™¨ ğŸ†—

```js
class NodeIterator {
  constructor(node) {
    this.node = node;
    this.nodeHandler = nodeHandler;
  }

  traverse(node) {
    const nodeIterator = new NodeIterator(node);
    const parse = this.nodeHandler[node.type];
    if (!parse) {
      throw new Error(`canjs: Unknown node type "${node.type}".`);
    }
    return parse(nodeIterator);
  }
}
```

ï¼ˆæœªå®Œå¾…ç»­~~~ï¼‰ğŸˆ